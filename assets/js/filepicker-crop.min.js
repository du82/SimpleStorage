(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],b):b(a.jQuery,a.Filepicker)})(this,function(a,b){"use strict";function c(a){a.extend(this,e)}function d(a){return a+=(-1<a.indexOf("?")?"&":"?")+new Date().getTime()}a="default"in a?a["default"]:a,b="default"in b?b["default"]:b;var e={crop:{selectors:{crop:".crop",container:"#crop-modal",loading:".crop-loading",preview:".crop-preview",save:".crop-save",hide:".crop-hide",rotateLeft:".crop-rotate-left",rotateRight:".crop-rotate-right",flipHorizontal:".crop-flip-horizontal",flipVertical:".crop-flip-vertical"},guides:!1,center:!1,movable:!1,zoomable:!1,setDragMode:"crop",viewMode:1},messages:{cropLoadFail:"Could not load the image.",cropSaveFail:"Could not save the image."},cropsave:function(a,b){b.original&&this.trigger("renderdownload",a,{files:[b]}),this.plugins.crop.hide()},cropsavefail:function(a,b){alert(b.responseJSON||this.trans("cropSaveFail"))},cropsavealways:function(){this.plugins.crop.toggleSaveBtn(),this.plugins.crop.image.cropper("enable")},cropload:function(a,b){var c=this.plugins.crop;c.options.loading&&c.options.loading.hide(),c.options._preview.html(b).show(),c.image=b.cropper(c.options),c.options.saveBtn.prop("disabled",!1),this.trigger("cropper",a,[c.image])},croploadfail:function(){alert(this.trans("cropLoadFail"))}};c.prototype.init=function(){this.options=this.$f.options.crop,this._initOptions(),this._initHandlers()},c.prototype._initOptions=function(){var b=this.options,c=this.options.selectors;return b.container||(b.container=a(c.container)),!!b.container&&void(!b.loading&&(b.loading=b.container.find(c.loading)),!b._preview&&(b._preview=b.container.find(c.preview)),!b.saveBtn&&(b.saveBtn=b.container.find(c.save),b.saveBtn.prop("disabled",!0)),!b.hideBtn&&(b.hideBtn=b.container.find(c.hide)),!b.rotateLeftBtn&&(b.rotateLeftBtn=b.container.find(c.rotateLeft)),!b.rotateRightBtn&&(b.rotateRightBtn=b.container.find(c.rotateRight)),!b.flipHorizontal&&(b.flipHorizontal=b.container.find(c.flipHorizontal)),!b.flipVertical&&(b.flipVertical=b.container.find(c.flipVertical)))},c.prototype._initHandlers=function(){var b=this,c=this.options;this.on(c.showBtn,"click",this.show),this.on(c.saveBtn,"click",this.save),this.on(c.hideBtn,"click",this.hide),this.on(c.rotateLeftBtn,"click",function(){return b.rotate(-90)}),this.on(c.rotateRightBtn,"click",function(){return b.rotate(90)}),this.on(c.flipHorizontal,"click",function(){if(b.image){var a=b.image.cropper("getData").scaleX;b.image.cropper("scaleX",1==a?-1:1)}}),this.on(c.flipVertical,"click",function(){if(b.image){var a=b.image.cropper("getData").scaleY;b.image.cropper("scaleY",1==a?-1:1)}}),this.isModal()&&c.container.on("hidden.bs.modal",function(){return b.hide()}).on("shown.bs.modal",function(c){b.loadPreview(c.relatedTarget.fileurl?c.relatedTarget.fileurl:a(c.relatedTarget.currentTarget))}),this.$f.plugins.ui&&(this.on(this.$f.element,"click",c.selectors.crop,this.show),this.$f.on("renderdone",function(b,d){a.each(d.files,function(a,b){b.context.find(c.selectors.crop).data("fileurl",b.url)})}))},c.prototype.show=function(b){if("object"===a.type(b))b.preventDefault();else{var c=b;b=a.Event("click"),b.fileurl=c}this.isModal()?this.options.container.modal("show",b):(this.options.container.show(),this.loadPreview(a(b.currentTarget)))},c.prototype.loadPreview=function(b){b instanceof a?(this.fileContext=a(b).closest(".download-template"),this.loadImage(a(b).data("fileurl"))):this.loadImage(b)},c.prototype.loadImage=function(b){var c=this,f=a("<img>",{src:d(b),class:"img-responsive"});f.on("load",function(a){return c.trigger("cropload",a,f)}).on("error",function(a){return c.trigger("croploadfail",a,f)})},c.prototype.hide=function(){this.isModal()?this.options.container.modal("hide"):this.options.container.hide(),this.options._preview.html("")},c.prototype.save=function(a){var b=this;this.toggleSaveBtn(),this.image.cropper("disable");var c=this.image.cropper("getData");this.$f.update(this.getFilename(),c).done(function(c,e,f){c.versions&&c.versions.thumb&&(c.versions.thumb.url=d(c.versions.thumb.url)),b.fileContext&&(c.original={context:b.fileContext}),b.trigger("cropsave",a,[c,f])}).fail(function(c){return b.trigger("cropsavefail",a,c)}).always(function(c){return b.trigger("cropsavealways",a,c)})},c.prototype.rotate=function(a){if(!this.image)return!1;var b=this.image,c=b.cropper("getContainerData");b.cropper("setCropBoxData",{width:2,height:2,top:c.height/2-1,left:c.width/2-1}),b.cropper("rotate",a);var d=void 0,e=b.cropper("getCanvasData"),f=e.width*(c.height/e.height);if(f>=c.width){var g=e.height*(c.width/e.width);d={width:c.width,height:g,top:(c.height-g)/2,left:0}}else d={width:f,height:c.height,top:0,left:(c.width-f)/2};b.cropper("setCanvasData",d),d.top+=.1*d.height,d.left+=.1*d.width,d.height*=.8,d.width*=.8,b.cropper("setCropBoxData",d)},c.prototype.getFilename=function(){var a=this.image.attr("src");return-1<a.indexOf("?file=")&&(a=a.substr(a.indexOf("?file=")+6)),(-1<a.indexOf("?")||-1<a.indexOf("&"))&&(a=a.substr(0,a.length-14)),decodeURI(a)},c.prototype.toggleSaveBtn=function(){var b=this.options.saveBtn;a.fn.button?b.button().data("bs.button").isLoading?b.button("reset"):b.button("loading"):b.prop("disabled",!b.prop("disabled"))},c.prototype.isModal=function(){return this.options.container&&this.options.container.hasClass("modal")},b.plugin("crop",c)});
