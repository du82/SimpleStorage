(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],b):b(a.jQuery,a.Filepicker)})(this,function(a,b){"use strict";function c(a){a.extend(this,d)}a="default"in a?a["default"]:a,b="default"in b?b["default"]:b;var d={camera:{constraints:{},flipHorizontal:!0,selectors:{container:"#camera-modal",show:".camera-show",hide:".camera-hide",capture:".camera-capture",preview:".camera-preview"}},messages:{cameraError:"Could not access the camera.",cameraFallback:"Your browser does not support the camera feature."},cameracapture:function(a,b){this.onAdd(a,b),this.plugins.camera.hide()},camerasuccess:function(a,b){var c=this.plugins.camera;c.stream=b,"srcObject"in c.video[0]?c.video[0].srcObject=b:c.video.attr("src",window.URL.createObjectURL(b)),c.video.on("loadedmetadata",function(){c.options.captureBtn.prop("disabled",!1)}),c.options.flipHorizontal&&c.flipHorizontal()},cameraerror:function(a,b){alert(this.trans("cameraError",{error:b})),this.plugins.camera.hide()},camerafallback:function(a,b){alert(b)}};c.prototype.init=function(){this.options=this.$f.options.camera,this._initOptions(),this._initHandlers()},c.prototype._initOptions=function(){var b=this.options,c=this.options.selectors;return this.mediaDevices=this._getMediaDevices(),b.container||(b.container=a(c.container)),!!b.container&&void(!b.showBtn&&(b.showBtn=this.$f.element.find(c.show)),!b.hideBtn&&(b.hideBtn=b.container.find(c.hide)),!b.captureBtn&&(b.captureBtn=b.container.find(c.capture)),!b.preview&&(b.preview=b.container.find(c.preview)),b.captureBtn.prop("disabled",!0))},c.prototype._initHandlers=function(){var a=this,b=this.options;this.on(b.showBtn,"click",this.show),this.on(b.hideBtn,"click",this.hide),this.on(b.captureBtn,"click",this.capture),this.isModal()&&b.container.on("shown.bs.modal",function(){return a.startStream()}).on("hidden.bs.modal",function(){return a.hide()})},c.prototype.show=function(a){return this.mediaDevices?void(this.isModal()?this.options.container.modal("show"):(this.options.container.show(),this.startStream())):this.trigger("camerafallback",a,this.$f.trans("cameraFallback"))},c.prototype.hide=function(){this.isModal()?this.options.container.modal("hide"):this.options.container.hide(),this.stopStream()},c.prototype.capture=function(a){var b={files:[this.getBlob()],autoUpload:!0};this.trigger("cameracapture",a,b)},c.prototype.startStream=function(){var b=this;this.video=a("<video autoplay></video>"),this.options.preview.html(this.video).show(),this.mediaDevices.getUserMedia({audio:!1,video:this.options.constraints}).then(function(a){return b.trigger("camerasuccess",null,a)}).catch(function(a){console.log(a)})},c.prototype.stopStream=function(){if(this.stream){if(this.stream.getVideoTracks){var a=this.stream.getVideoTracks();a&&a[0]&&a[0].stop&&a[0].stop()}else this.stream.stop&&this.stream.stop();delete this.stream}this.video&&(this.video.remove(),delete this.video)},c.prototype.flipHorizontal=function(){this.options.preview.css({transform:"scaleX(-1)",mozTransform:"scaleX(-1)",webkitTransform:"scaleX(-1)"})},c.prototype.getBlob=function(){var a=this._getDataUri(),b=a.split("data:image/jpeg;base64,")[1],c=this._encode(b),d=new Blob([c],{type:"image/jpeg"});return d.name="camera"+Math.round(1e3*Math.random())+".jpg",d.lastModifiedDate=new Date,d},c.prototype._getDataUri=function(){var a=document.createElement("canvas");a.width=this.video[0].videoWidth,a.height=this.video[0].videoHeight;var b=a.getContext("2d");return this.options.flipHorizontal&&(b.translate(this.video[0].videoWidth,0),b.scale(-1,1)),b.drawImage(this.video[0],0,0),a.toDataURL("image/jpeg")},c.prototype.isModal=function(){return this.options.container&&this.options.container.hasClass("modal")},c.prototype._getMediaDevices=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:navigator.mozGetUserMedia||navigator.webkitGetUserMedia?{getUserMedia:function(a){return new Promise(function(b,c){(navigator.mozGetUserMedia||navigator.webkitGetUserMedia).call(navigator,a,b,c)})}}:null},c.prototype._encode=function(a){for(var b=atob(a),c=b.length,d=new ArrayBuffer(c),e=new Uint8Array(d),f=0;f<c;f++)e[f]=b.charCodeAt(f);return d},b.plugin("camera",c)});
